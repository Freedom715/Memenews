{% extends "base.html" %}

{% block content %}
<div class="col-xl">
    <h1>Новости</h1>
    {% if current_user.is_authenticated %}
    <a href="news" class="btn btn-secondary" style="margin-bottom:10px">Добавить новость</a> <br>
    {% endif %}
    {% for item in news[::-1]%}
    <div class="col">
        <div class="row block rounded-lg">
            <div class="media col-md" style="margin-top:15px">
                <a href="/profile/{{item.user.id}}" name="{{item.id}}">
                    <img src="{{item.user.avatar}}"
                         class="align-self-start mr-3 rounded-lg" alt="PEP8"
                         width="100"
                         height="100" title="{{item.user.name}}">
                </a>
                <div class="media-body md-0">
                    <h2 class="text-break text">{{item.title}}</h2>
                    <p class="text-break text">
                        {{item.content}} </p><br>
                    {% if item.image %}
                    <img src="{{item.image}}"
                         class="align-self-center mr-4 w-100 rounded-sm"> <br>
                    {% endif %}
                </div>
            </div>
            <div class="col-4" style="margin-top:15px;">
                <div style="margin-bottom: 5px; margin-top: 3px">
                    {% if current_user.is_authenticated %}
                    <a onclick="like({{item.id}});"><img
                            src="/static/img/images/{{ base.like_image }}{{ check_like(item.id, lst) }}.png"
                            width="100" height="100"></a>
                    <p>{{check_number_of_like(item.liked)[0].title()}} {{item.liked}}
                        {{check_number_of_like(item.liked)[1]}}
                        {% endif %}
                    </p>
                    {% if current_user == item.user %}
                    {% if item.liked < 3 %}
                    <a href="/news/{{ item.id }}" class="btn btn-block btn-warning"
                       style="margin-bottom:5px">Изменить</a>
                    {% endif %}
                    <input type="button" value="Удалить" class="btn btn-block btn-danger"
                           onclick="delete_news({{item.id}});">
                    {% endif %}
                </div>
            </div>
            <div class="col-8" style="margin-left:115px; margin-right:115;">
                {% for elem in comments %}
                {% if elem.news_id == item.id %}
                <div class="media mt-3 invert_block rounded-lg">
                    <img src="{{elem.user.avatar}}"
                         class="align-self-start mr-3 rounded-lg"
                         width="50"
                         alt="PEP8">
                    <div class="media-body">
                        <h5 class="mt-0 text-break">{{elem.user.name}}</h5>
                        <p class="text-break"> {{elem.text}} <br>
                            {% if current_user.id == elem.user.id %}
                            <button class="btn btn-sm btn-secondary" style="margin-top"
                                    onclick="delete_comment({{elem.id}})"> Удалить
                            </button>
                            {% endif %}
                    </div>
                </div>
                {% endif %}

                {% endfor %}
                {% if current_user.is_authenticated %}
                <div class="input-group mb-3">
                    <input type="text"
                           class="form-control"
                           id="comment{{item.id}}">
                    <div>
                        <input type="button"
                               style="margin-bottom:10px"
                               class="btn btn-secondary"
                               value="Отправить"
                               onclick="add_comment({{item.id}});">
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    <script type="text/javascript">
function add_comment(news_id) {
var input = document.getElementById("comment" + news_id);
$.ajax({
            url: '/api/v2/comments',
            type: 'post',
            data: {"text": input.value, "user_id": {{current_user.id}},
             "news_id": news_id },
            response: 'json',
            success: function(data) {input.value = "";
                                    redraw();}
        });
};

function delete_comment(comment_id) {
$.ajax({
            url: '/api/v2/comments/' + comment_id,
            type: 'delete',
            response: 'json',
            success: function(data) {redraw();}
        });
}

function delete_news(news_id) {
$.ajax({
            url: '/api/v2/news/' + news_id,
            type: 'delete',
            response: 'json',
            success: function(data) {redraw();}
        });
}

function redraw() {
    fetch("/").then(response => response.text())
        .then(result => document.querySelector('html').innerHTML = result)
}

function like(news_id) {
$.ajax({
            url: '/api/v2/likes/' + news_id,
            type: 'get',
            response: 'json',
            success: function(data) {redraw();}
        });


}





















    </script>
    {% endblock %}